#!/bin/bash
set -eux -o pipefail

ghc_warnings=(
    -Wall -Wcompat -Wincomplete-record-updates -Wincomplete-uni-patterns
    -Wredundant-constraints
    -Wwarn=missing-signatures -Wwarn=type-defaults -Wwarn=unused-top-binds
    -Wno-unticked-promoted-constructors
)

ghc_options=(-fforce-recomp -Werror "${ghc_warnings[@]}")

stack_options=(--no-terminal --install-ghc)

case "$1" in
    ghc)
        shift
        ghc "${ghc_options[@]}" "$@"
        ;;
    stack-test)
        shift
        stack "${stack_options[@]}"                         \
            test --pedantic "--ghc-options=${ghc_warnings[*]}" "$@"
        ;;
    *)
        exit 1
        ;;
esac
